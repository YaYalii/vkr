<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>SpeechSearch</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=K2D:wght@100;800&display=swap" rel="stylesheet">
</head>
<body>
<header>
    <div  class="logo">
        SpeechSearch
    </div>
    <div class="menu">
        <a href="{% url 'main_page' %}" class="menu-button page-chat">–ü–æ–∏—Å–∫</a>
        <a href="{% url 'report' %}"  class="menu-button page-reports">–û—Ç—á–µ—Ç—ã</a>
        <a href="{% url 'chat' %}" class="menu-button page-chat">–ß–∞—Ç</a>
    </div>
    <div class="profile">
        <span class="profile-name"></span>
        <a  class="profile-img" href="">
            <img src="{% static 'images/profile_logo.png' %}"  class="profile-logo">
        </a>
    </div>
</header>
<div class="chat-container">
    <span class="chat-header">–ß–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
    <div class="chat-grid">
        <div class="prompt-container">
            <div class="prompt-list" id="chat-messages">
                <div class="prompt-start-text">
                    <span>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å.</span>
                </div>
            </div>
        </div>
        <form id="chat-form">
            <div class="prompt-chat-container">
                <div>
                    <textarea class="chat-input-textarea" id="user-input" required></textarea>
                </div>
                <div>
                    <button type="submit" class="submit-button">
                        <img src="{% static 'images/send_prompt_button.png' %}" class="submit-button-icon">
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const input = document.getElementById('user-input');
    const message = input.value.trim();
    if (!message) return;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
    addMessage(message, 'user');
    input.value = '';

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch('/api/giga-search/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ prompt: message })
        });

        const data = await response.json();

        if (data.results && data.results.length > 0) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            let assistantResponse = "–ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –¥–∏–∞–ª–æ–≥–∏:\n\n";
            data.results.forEach(result => {
                assistantResponse += `üîπ ${result.text}\n`;
                if (result.reason) {
                    assistantResponse += `   (${result.reason})\n\n`;
                }
            });

            addMessage(assistantResponse, 'assistant');
        } else {
            addMessage("–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", 'assistant');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        addMessage("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.", 'assistant');
    }
});

function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.textContent = text;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
</script>
</body>
</html>